name: Ejercicio 10 - Performance y Recursos

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Permite ejecuci√≥n manual

jobs:
  performance-test:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout del c√≥digo
    - uses: actions/checkout@v4
    
    # 2. Informaci√≥n inicial del sistema
    - name: System info before
      id: sys-before
      run: |
        echo "=== RECURSOS INICIALES ==="
        echo ""
        
        echo "üìä CPU:"
        echo "N√∫cleos: $(nproc)"
        lscpu | grep "Model name" | sed 's/Model name:/Modelo:/'
        echo ""
        
        echo "üíæ Memoria:"
        free -h
        echo ""
        
        echo "üíø Disco:"
        df -h
        echo ""
        
        echo "üìà Procesos activos:"
        ps aux --no-headers | wc -l
        echo ""
        
        echo "‚è∞ Tiempo inicial: $(date '+%Y-%m-%d %H:%M:%S')"
        
        # Guardar m√©tricas para comparaci√≥n
        MEM_INICIAL=$(free -m | awk '/^Mem:/{print $3}')
        echo "MEM_INICIAL_MB=$MEM_INICIAL" >> $GITHUB_ENV
        
    # 3. Operaci√≥n pesada (con cach√© para optimizar)
    - name: Cache dependencies
      id: cache-npm
      uses: actions/cache@v4
      with:
        path: ~/.npm
        key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-npm-
    
    - name: Heavy operation
      id: heavy-op
      timeout-minutes: 10  # Timeout para evitar ejecuciones infinitas
      run: |
        echo "‚ñ∂Ô∏è Iniciando operaciones pesadas..."
        START_TIME=$(date +%s)
        
        # Instalar dependencias
        echo "üì¶ Instalando dependencias..."
        npm ci --silent
        
        # Ejecutar tests (simula carga)
        echo "üß™ Ejecutando tests..."
        npm test 2>&1 | tail -20
        
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        echo "DURACION_SEGUNDOS=$DURATION" >> $GITHUB_ENV
        echo "‚úÖ Operaci√≥n completada en $DURATION segundos"
        
    # 4. Informaci√≥n del sistema despu√©s
    - name: System info after
      if: always()  # Siempre ejecutar, incluso si fallan pasos anteriores
      run: |
        echo ""
        echo "=== RECURSOS DESPU√âS ==="
        echo ""
        
        echo "üìä CPU (uso):"
        top -bn1 | grep "Cpu(s)" | awk '{print "Uso: " $2 "% us"}'
        echo ""
        
        echo "üíæ Memoria:"
        free -h
        echo ""
        
        # Comparaci√≥n de memoria usada
        MEM_ACTUAL=$(free -m | awk '/^Mem:/{print $3}')
        MEM_USADA=$((MEM_ACTUAL - $MEM_INICIAL_MB))
        echo "üìà Memoria adicional usada: ${MEM_USADA} MB"
        echo ""
        
        echo "üíø Disco:"
        df -h
        DISCO_USADO=$(df -h . | awk 'NR==2 {print $5}')
        echo "Uso de disco en workspace: $DISCO_USADO"
        echo ""
        
        echo "üìà Procesos activos:"
        ps aux --no-headers | wc -l
        echo ""
        
        echo "‚è∞ Tiempo final: $(date '+%Y-%m-%d %H:%M:%S')"
    
    # 5. M√©tricas de tiempo
    - name: Time measurement
      run: |
        echo ""
        echo "=== TIEMPOS DE EJECUCI√ìN ==="
        echo ""
        
        # Usar variable del job si est√° disponible
        if [ -n "$DURACION_SEGUNDOS" ]; then
          echo "‚è±Ô∏è  Duraci√≥n de 'Heavy operation': $DURACION_SEGUNDOS segundos"
        fi
        
        echo "üìä Estad√≠sticas del runner:"
        echo "Runner: ${{ runner.os }} - ${{ runner.name }}"
        echo "Workflow: ${{ github.workflow }}"
        
    # 6. An√°lisis de cuellos de botella
    - name: Analyze bottlenecks
      if: always()
      run: |
        echo ""
        echo "=== AN√ÅLISIS DE RENDIMIENTO ==="
        echo ""
        
        # Analizar procesos que m√°s CPU usan
        echo "üîç Top 5 procesos por CPU:"
        ps aux --sort=-%cpu | head -6 | awk '{print $3 "% CPU - " $11}'
        echo ""
        
        # Analizar procesos que m√°s memoria usan
        echo "üîç Top 5 procesos por memoria:"
        ps aux --sort=-%mem | head -6 | awk '{print $4 "% MEM - " $11}'
        echo ""
        
        # Recomendaciones b√°sicas
        echo "üí° RECOMENDACIONES:"
        echo "1. Usa caching para dependencias (npm, pip, etc.)"
        echo "2. Divide jobs largos en varios m√°s peque√±os"
        echo "3. Usa runners m√°s potentes si necesitas m√°s recursos"
        echo "4. Limpia archivos temporales despu√©s de cada step"
        echo "5. Considera jobs paralelos cuando sea posible"
    
    # 7. Limpieza opcional
    - name: Cleanup
      if: always()
      run: |
        echo "üßπ Limpiando archivos temporales..."
        # Limpiar cache npm si es muy grande
        # npm cache clean --force
        
        # Mostrar espacio liberado
        echo "Espacio disponible despu√©s de limpieza:"
        df -h . | awk 'NR==2 {print "Disco: " $4 " libres de " $2}'